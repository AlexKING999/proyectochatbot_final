import streamlit as st
import requests
import os
import time
import re

# Configuraci√≥n de la p√°gina
st.set_page_config(
    page_title="Chatbot ISTA - Instituto Tecnol√≥gico del Azuay",
    page_icon="üéì",
    layout="wide",
    initial_sidebar_state="expanded"
)

# URL de la API
API_BASE_URL = os.getenv('API_BASE_URL', 'https://nghki1cldwq3.manussite.space')

# CSS personalizado para mejorar la apariencia
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(90deg, #035AA6 0%, #F2B705 100%);
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        text-align: center;
        color: white;
    }
    
    .chat-message {
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 10px;
        border-left: 4px solid #035AA6;
        background-color: #f8f9fa;
    }
    
    .user-message {
        background-color: #e3f2fd;
        border-left-color: #2196f3;
        text-align: right;
    }
    
    .bot-message {
        background-color: #f1f8e9;
        border-left-color: #4caf50;
    }
    
    .quick-action-btn {
        background-color: #035AA6;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        margin: 0.2rem;
        cursor: pointer;
        width: 100%;
        text-align: left;
    }
    
    .quick-action-btn:hover {
        background-color: #F2B705;
        color: #035AA6;
    }
    
    .status-indicator {
        padding: 0.5rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: bold;
    }
    
    .status-connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .form-container {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        border: 2px solid #035AA6;
        margin: 1rem 0;
    }
    
    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 5px;
        border: 1px solid #c3e6cb;
        margin: 1rem 0;
    }
    
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 5px;
        border: 1px solid #f5c6cb;
        margin: 1rem 0;
    }
</style>
""", unsafe_allow_html=True)

# Funciones auxiliares
def check_api_connection():
    """Verifica la conexi√≥n con la API"""
    try:
        response = requests.get(f"{API_BASE_URL}/api/health", timeout=5)
        return response.status_code == 200
    except:
        return False

def send_message_to_api(message):
    """Env√≠a un mensaje a la API del chatbot"""
    try:
        response = requests.post(
            f"{API_BASE_URL}/api/chat/message",
            json={"message": message},
            timeout=10
        )
        if response.status_code == 200:
            return response.json().get('response', 'Error: No se recibi√≥ respuesta')
        else:
            return "Error: No se pudo procesar tu mensaje. Intenta de nuevo."
    except requests.exceptions.Timeout:
        return "Error: La conexi√≥n tard√≥ demasiado. Verifica tu conexi√≥n a internet."
    except:
        return "Error: No se pudo conectar con el servidor. Intenta m√°s tarde."

def get_carreras_for_form():
    """Obtiene la lista de carreras para el formulario"""
    try:
        response = requests.get(f"{API_BASE_URL}/api/matricula/carreras", timeout=10)
        if response.status_code == 200:
            data = response.json()
            if data.get('success'):
                return data.get('carreras', [])
        return []
    except:
        return []

def submit_matricula_form(form_data):
    """Env√≠a el formulario de matr√≠cula"""
    try:
        response = requests.post(
            f"{API_BASE_URL}/api/matricula/submit",
            json=form_data,
            timeout=10
        )
        return response.json()
    except:
        return {'success': False, 'message': 'Error de conexi√≥n'}

def format_bot_response(response):
    """Formatea la respuesta del bot para mostrar mejor en Streamlit"""
    # Convertir **texto** a markdown bold
    response = re.sub(r'\*\*(.*?)\*\*', r'**\1**', response)
    
    # Asegurar que los emojis se muestren correctamente
    return response

# Inicializaci√≥n del estado de la sesi√≥n
if 'messages' not in st.session_state:
    st.session_state.messages = []
if 'api_connected' not in st.session_state:
    st.session_state.api_connected = check_api_connection()
if 'show_form' not in st.session_state:
    st.session_state.show_form = False
if 'form_submitted' not in st.session_state:
    st.session_state.form_submitted = False

# Header principal
st.markdown("""
<div class="main-header">
    <h1>üéì Chatbot ISTA</h1>
    <h3>Instituto Superior Tecnol√≥gico del Azuay</h3>
    <p>Tu asistente virtual para informaci√≥n acad√©mica</p>
</div>
""", unsafe_allow_html=True)

# Layout principal con columnas
col1, col2 = st.columns([2, 1])

with col1:
    # Indicador de estado de conexi√≥n
    if st.session_state.api_connected:
        st.markdown("""
        <div class="status-indicator status-connected">
            ‚úÖ Conectado al servidor - Listo para chatear
        </div>
        """, unsafe_allow_html=True)
    else:
        st.markdown("""
        <div class="status-indicator status-disconnected">
            ‚ùå Sin conexi√≥n al servidor - Verifica tu internet
        </div>
        """, unsafe_allow_html=True)
        
        if st.button("üîÑ Reconectar"):
            st.session_state.api_connected = check_api_connection()
            st.rerun()

    # Mostrar formulario de matr√≠cula si est√° activado
    if st.session_state.show_form and not st.session_state.form_submitted:
        st.markdown("### üìù Formulario de Matr√≠cula")
        
        with st.form("matricula_form"):
            st.markdown("""
            <div class="form-container">
                <h4>üéì Solicitud de Matr√≠cula - ISTA</h4>
                <p>Completa todos los campos para procesar tu solicitud de matr√≠cula.</p>
            </div>
            """, unsafe_allow_html=True)
            
            # Campos del formulario
            nombre_completo = st.text_input("üë§ Nombre Completo *", placeholder="Ej: Juan Carlos P√©rez L√≥pez")
            cedula = st.text_input("üÜî C√©dula de Identidad *", placeholder="Ej: 0123456789")
            email = st.text_input("üìß Correo Electr√≥nico *", placeholder="Ej: juan.perez@email.com")
            telefono = st.text_input("üìû Tel√©fono *", placeholder="Ej: +593 99 123 4567")
            
            # Obtener carreras para el select
            carreras = get_carreras_for_form()
            if carreras:
                carrera_options = [f"{carrera['nombre']} ({carrera['modalidad']})" for carrera in carreras]
                carrera_interes = st.selectbox("üéØ Carrera de Inter√©s *", carrera_options)
            else:
                carrera_interes = st.text_input("üéØ Carrera de Inter√©s *", placeholder="Escribe la carrera que te interesa")
            
            # Campos adicionales
            col_form1, col_form2 = st.columns(2)
            with col_form1:
                fecha_nacimiento = st.date_input("üìÖ Fecha de Nacimiento")
                genero = st.selectbox("üë• G√©nero", ["Masculino", "Femenino", "Otro", "Prefiero no decir"])
            
            with col_form2:
                ciudad = st.text_input("üèôÔ∏è Ciudad de Residencia", placeholder="Ej: Cuenca")
                nivel_educacion = st.selectbox("üéì Nivel de Educaci√≥n", 
                    ["Bachiller", "T√©cnico", "Tecn√≥logo", "Universitario", "Otro"])
            
            # Informaci√≥n adicional
            st.text_area("üí¨ Comentarios Adicionales (Opcional)", 
                        placeholder="Cualquier informaci√≥n adicional que consideres importante...")
            
            # T√©rminos y condiciones
            acepta_terminos = st.checkbox("‚úÖ Acepto los t√©rminos y condiciones del ISTA")
            
            # Bot√≥n de env√≠o
            submitted = st.form_submit_button("üöÄ Enviar Solicitud de Matr√≠cula", 
                                            disabled=not acepta_terminos)
            
            if submitted:
                # Validar campos requeridos
                if not all([nombre_completo, cedula, email, telefono, carrera_interes]):
                    st.markdown("""
                    <div class="error-message">
                        ‚ùå Por favor completa todos los campos marcados con *
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    # Preparar datos del formulario
                    form_data = {
                        'nombre_completo': nombre_completo,
                        'cedula': cedula,
                        'email': email,
                        'telefono': telefono,
                        'carrera_interes': carrera_interes,
                        'fecha_nacimiento': str(fecha_nacimiento),
                        'genero': genero,
                        'ciudad': ciudad,
                        'nivel_educacion': nivel_educacion
                    }
                    
                    # Enviar formulario
                    result = submit_matricula_form(form_data)
                    
                    if result.get('success'):
                        st.session_state.form_submitted = True
                        st.session_state.form_result = result
                        st.rerun()
                    else:
                        st.markdown(f"""
                        <div class="error-message">
                            ‚ùå Error: {result.get('message', 'No se pudo enviar el formulario')}
                        </div>
                        """, unsafe_allow_html=True)

    # Mostrar resultado del formulario si fue enviado
    if st.session_state.form_submitted and 'form_result' in st.session_state:
        result = st.session_state.form_result
        st.markdown(f"""
        <div class="success-message">
            <h4>üéâ ¬°Formulario Enviado Exitosamente!</h4>
            <p><strong>Nombre:</strong> {result['data']['nombre']}</p>
            <p><strong>Carrera:</strong> {result['data']['carrera']}</p>
            <p><strong>N√∫mero de Solicitud:</strong> {result['data']['numero_solicitud']}</p>
            <p>üìû Te contactaremos pronto al n√∫mero proporcionado.</p>
            <p>‚úâÔ∏è Tambi√©n recibir√°s un correo de confirmaci√≥n.</p>
        </div>
        """, unsafe_allow_html=True)
        
        if st.button("üîÑ Enviar Otro Formulario"):
            st.session_state.form_submitted = False
            st.session_state.show_form = False
            del st.session_state.form_result
            st.rerun()

    # √Årea de chat
    st.markdown("### üí¨ Chat con el Asistente Virtual")
    
    # Contenedor para mensajes
    chat_container = st.container()
    
    with chat_container:
        # Mostrar historial de mensajes
        for i, message in enumerate(st.session_state.messages):
            if message["role"] == "user":
                st.markdown(f"""
                <div class="chat-message user-message">
                    <strong>üë§ T√∫:</strong><br>
                    {message["content"]}
                </div>
                """, unsafe_allow_html=True)
            else:
                formatted_response = format_bot_response(message["content"])
                st.markdown(f"""
                <div class="chat-message bot-message">
                    <strong>ü§ñ Asistente ISTA:</strong><br>
                    {formatted_response}
                </div>
                """, unsafe_allow_html=True)

    # Input para nuevos mensajes
    if st.session_state.api_connected:
        with st.form("chat_form", clear_on_submit=True):
            col_input, col_send = st.columns([4, 1])
            
            with col_input:
                user_input = st.text_input("üí≠ Escribe tu mensaje...", 
                                         placeholder="Ej: Quiero informaci√≥n sobre las carreras",
                                         label_visibility="collapsed")
            
            with col_send:
                send_button = st.form_submit_button("üì§ Enviar", use_container_width=True)
            
            if send_button and user_input:
                # Agregar mensaje del usuario
                st.session_state.messages.append({"role": "user", "content": user_input})
                
                # Verificar si el usuario quiere el formulario
                if any(keyword in user_input.lower() for keyword in 
                       ["formulario", "matricula", "matr√≠cula", "inscripci√≥n", "inscripcion"]):
                    st.session_state.show_form = True
                
                # Obtener respuesta del bot
                with st.spinner("ü§ñ Procesando tu mensaje..."):
                    bot_response = send_message_to_api(user_input)
                
                # Agregar respuesta del bot
                st.session_state.messages.append({"role": "assistant", "content": bot_response})
                
                st.rerun()

with col2:
    # Sidebar con opciones r√°pidas
    st.markdown("### üöÄ Opciones R√°pidas")
    st.markdown("*Haz clic en cualquier opci√≥n para enviar la pregunta autom√°ticamente*")
    
    # Opciones r√°pidas numeradas
    quick_actions = [
        ("1Ô∏è‚É£ üéì Ver todas las carreras", "Quiero ver todas las carreras disponibles"),
        ("2Ô∏è‚É£ üìû Informaci√≥n de contacto", "Necesito la informaci√≥n de contacto del ISTA"),
        ("3Ô∏è‚É£ üìã Proceso de matr√≠cula", "¬øC√≥mo es el proceso de matr√≠cula?"),
        ("4Ô∏è‚É£ üéØ Modalidades de estudio", "¬øQu√© modalidades de estudio ofrecen?"),
        ("5Ô∏è‚É£ üïê Horarios y jornadas", "¬øCu√°les son los horarios y jornadas?"),
        ("6Ô∏è‚É£ üí∞ Informaci√≥n de costos", "¬øCu√°nto cuestan las carreras?"),
        ("7Ô∏è‚É£ üìù Formulario de matr√≠cula", "Quiero llenar el formulario de matr√≠cula")
    ]
    
    for button_text, message in quick_actions:
        if st.button(button_text, key=f"quick_{message}", use_container_width=True):
            if st.session_state.api_connected:
                # Agregar mensaje del usuario
                st.session_state.messages.append({"role": "user", "content": message})
                
                # Verificar si es el formulario
                if "formulario" in message.lower():
                    st.session_state.show_form = True
                
                # Obtener respuesta del bot
                with st.spinner("ü§ñ Procesando..."):
                    bot_response = send_message_to_api(message)
                
                # Agregar respuesta del bot
                st.session_state.messages.append({"role": "assistant", "content": bot_response})
                
                st.rerun()
            else:
                st.error("‚ùå Sin conexi√≥n al servidor")

    # Informaci√≥n adicional
    st.markdown("---")
    st.markdown("### üìç Informaci√≥n de Contacto")
    st.markdown("""
    **üèõÔ∏è Instituto Superior Tecnol√≥gico del Azuay**
    
    üìç **Ubicaci√≥n:** Parque Industrial, Cuenca
    
    üìû **Tel√©fono:** +593 99 536 3076
    
    ‚úâÔ∏è **Email:** secretaria@tecazuay.edu.ec
    
    üåê **Web:** tecazuay.edu.ec
    
    üì± **Redes:** @tecdelazuay
    """)
    
    st.markdown("---")
    st.markdown("### üïê Horarios de Atenci√≥n")
    st.markdown("""
    **Lunes a Viernes:** 8:00 AM - 5:00 PM
    
    **S√°bados:** 8:00 AM - 12:00 PM
    
    **Domingos:** Cerrado
    """)
    
    # Bot√≥n para limpiar chat
    if st.button("üóëÔ∏è Limpiar Chat", use_container_width=True):
        st.session_state.messages = []
        st.session_state.show_form = False
        st.session_state.form_submitted = False
        if 'form_result' in st.session_state:
            del st.session_state.form_result
        st.rerun()

# Footer
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #666; padding: 1rem;">
    <p>üéì <strong>Instituto Superior Tecnol√≥gico del Azuay (ISTA)</strong></p>
    <p>Educaci√≥n tecnol√≥gica de calidad ‚Ä¢ T√≠tulos reconocidos por SENESCYT ‚Ä¢ 100% Gratuito</p>
    <p><em>Desarrollado con ‚ù§Ô∏è para la comunidad estudiantil</em></p>
</div>
""", unsafe_allow_html=True)

